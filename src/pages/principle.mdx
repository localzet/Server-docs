export const pageTitle = 'Принцип работы'

# Принцип работы

![Мастер-процесс](/images/master-process.jpg "Мастер-процесс")

**Мастер-процесс** {{ className: 'color-theme' }} - это основной процесс, который начинает работу, как только вы запускаете Localzet Server и выполняет всю процедуру запуска. Он не участвует в обработке запросов, а служит лишь для поддержания стабильности, мониторинга и управления дочерними процессами. {{ className: 'lead' }}

1. **Проверка среды** {{ className: 'color-theme' }} - перед началом работы процесс должен убедиться, что он запущен из терминала и система соответствует минимальным требованиям. {{ className: 'lead' }}
2. **Демонизация** {{ className: 'color-theme' }} - здесь процесс переходит в фоновый режим (daemon). {{ className: 'lead' }}
3. **Установка сигналов** {{ className: 'color-theme' }} - так процесс, выполняемый в Unix-подобной системе, сообщает самой ОС о том, какие сигналы POSIX может принимать и устанавливает обработчики. {{ className: 'lead' }}
4. **Создание сокета** {{ className: 'color-theme' }} - на этом этапе процесс создаёт слушающий сокет с параметрами, которые вы передали серверу (`$socketName` и `$socketContext`). {{ className: 'lead' }}
5. **Создание форков** {{ className: 'color-theme' }} - т.к. сам мастер-процесс не принимает соединения, этим занимаются дочерние процессы (форки). {{ className: 'lead' }}
6. **Мониторинг сигналов** {{ className: 'color-theme' }} - последним этапом запуска является переход в режим мониторинга и обработки входящих POSIX-сигналов для управления форками. {{ className: 'lead' }}

![Логика рабочего процесса](/images/fork-process.jpg "Логика рабочего процесса")

**Рабочие процессы** - это дочерние процессы, которые обрабатывают входящие соединения и выполняют основную логику вашего приложения. Каждый такой процесс работает независимо и может обслуживать сотни тысяч входящих соединений. {{ className: 'lead' }}

1. **Epoll слушает события** {{ className: 'color-theme' }} - при новом входящем событии [Epoll](https://lwn.net/Articles/520012/ "I/O event notification facility") решает, какому сокету его передать. {{ className: 'lead' }}
2. **Логическая обработка** {{ className: 'color-theme' }} - после получения запроса процесс передаёт его обработчикам протоколов транспортного и прикладного уровней, а после - вашему обработчику. {{ className: 'lead' }}
3. **Возврат ответа** {{ className: 'color-theme' }} - после выполнения основной логики приложения, клиенту возвращается ответ, посредством ранее определённых протоколов. {{ className: 'lead' }}
4. **Обратная связь** {{ className: 'color-theme' }} - в конечном итоге процесс возвращается к исходному состоянию для принятия новых соединений. {{ className: 'lead' }}

<Row>
    <Col>
        ![Сигналы POSIX](/images/posix-signals.jpg "Сигналы POSIX")
    </Col>
    <Col>
        <br/>
        [**Сигналы POSIX**](https://en.wikipedia.org/wiki/Signal_(IPC) "Signal (IPC) - Wikipedia") - это асинхронное
        уведомление процесса о каком-либо событии, один из основных способов взаимодействия между процессами в
        Unix-подобных системах. По умолчанию, при получении сигнала, операционная система прерывает выполнение процесса,
        если процессом не задан обработчик соответствующего сигнала. {{className: 'lead'}}

        В Localzet Server предустановлены обработчики сигналов `SIGINT`, `SIGTERM`, `SIGHUP`, `SIGTSTP`, `SIGQUIT`,
        `SIGUSR1`, `SIGUSR2`, `SIGIOT` и `SIGIO`. На схеме наглядно показаны сигналы и действия, к которым они приведут
        при взаимодействии с процессом сервера. {{className: 'lead'}}

        `SIGQUIT` и `SIGUSR2` отвечают за, так называемую, "плавную" остановку и перезагрузку. Плавность здесь - это
        процесс закрытия всех соединений перед остановкой или перезагрузкой сервера. Так сервер сообщит клиентам, что
        выключается, а не грубо оборвёт соединения. {{className: 'lead'}}
    </Col>
</Row>
